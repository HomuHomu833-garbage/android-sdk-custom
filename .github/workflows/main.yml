name: Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Specific Branches or Tags"
        required: true
        default: "platform-tools-35.0.2"

jobs:
  build:
    name: build
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - target_arch: arm
            target_triple: arm-linux-musleabi
          - target_arch: armhf
            target_triple: arm-linux-musleabihf
          - target_arch: arm64
            target_triple: aarch64-linux-musl
          - target_arch: loongarch64
            target_triple: loongarch64-linux-musl
          - target_arch: riscv32
            target_triple: riscv32-linux-musl
          - target_arch: riscv64
            target_triple: riscv64-linux-musl
          - target_arch: x86
            target_triple: x86-linux-musl
          - target_arch: x86_64
            target_triple: x86_64-linux-musl
    env:
      ZIG_TARGET: ${{ matrix.target_triple }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v1.2.1
        with:
          version: "0.15.0-dev.137+db7db4802"
          use-cache: false

      - name: Setup Zig Toolchain
        run: |
          cd ${{ github.workspace }}
          git clone https://github.com/HomuHomu833/zig-as-llvm

      - name: Get Sources
        run: python get_source.py --tags "${{ inputs.tag }}"

      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y golang ninja-build autogen autoconf autoconf-archive m4 libtool build-essential qemu-user-static nasm

      - name: Build Host protobuf
        run: |
          if ! test -f "${PROTOBUF}"; then
              patch -up1 <"${{ github.workspace }}/patches/protobuf_CMakeLists.txt.patch"
              BUILD="${{ github.workspace }}/src/protobuf/build"
              rm -rf "${BUILD}" && mkdir -p "${BUILD}"
              cmake -S"${{ github.workspace }}/src/protobuf" -B"${BUILD}" -GNinja -Dprotobuf_BUILD_TESTS=OFF
              ninja -C "${BUILD}" -j"$(nproc --all)"
          fi

      - name: Apply Patches
        run: |
          sed -i '/};/ a\
          #ifndef TEMP_FAILURE_RETRY\
          #define TEMP_FAILURE_RETRY(expression) (({ long int __result; do __result = (long int)(expression); while (__result == -1 && errno == EINTR); __result; }))\
          #endif\
          #ifndef PAGE_SIZE\
          #define PAGE_SIZE 4096\
          #endif' ${PWD}/src/logging/liblog/logger.h
          sed -i '/__END_DECLS/i\
          #ifndef TEMP_FAILURE_RETRY\n\
          #define TEMP_FAILURE_RETRY(expression) (({ long int __result; do __result = (long int)(expression); while (__result == -1 && errno == EINTR); __result; }))\n\
          #endif\n' ${PWD}/src/core/libcutils/include/cutils/klog.h
          sed '/#ifdef __cplusplus/ { 
              n; 
              n; 
              i\
          #ifndef TEMP_FAILURE_RETRY\\
          #define TEMP_FAILURE_RETRY(expression) (({ long int __result; do __result = (long int)(expression); while (__result == -1 && errno == EINTR); __result; }))\\
          #endif
          }' ${PWD}/src/core/libcutils/include/cutils/uevent.h
          sed -i '/#include "uio.h"/a #include <atomic>' ${PWD}/src/logging/liblog/logger.h
          sed -i 's/static atomic_int pmsg_fd;/static std::atomic<int> pmsg_fd{0};/' ${PWD}/src/logging/liblog/pmsg_writer.cpp
          sed -i 's|#include <stdatomic.h>|#include <atomic>|' ${PWD}/src/logging/liblog/logd_reader.cpp ${PWD}/src/logging/liblog/logd_writer.cpp ${PWD}/src/logging/liblog/logger.h
          sed -i 's/\batomic_int\b/std::atomic<int>/g' ${PWD}/src/logging/liblog/logger.h
          sed -i 's/^ *atomic_int \([^=;]*\)= *\([^;]*\);/std::atomic<int> \1{\2};/g' ${PWD}/src/logging/liblog/logd_writer.cpp
          sed -i 's/static atomic_int dropped;/static std::atomic<int> dropped{0};/' ${PWD}/src/logging/liblog/logd_writer.cpp
          sed -i 's/\bmemory_order_relaxed\b/std::memory_order_relaxed/g' ${PWD}/src/logging/liblog/logd_writer.cpp

          find ${PWD}/src -type f \( -name "*.c" -o -name "*.cpp" -o -name "*.h" \) -exec sed -i '/#include <sys\/cdefs.h>/c\
          #ifdef __cplusplus\
          #ifndef __GLIBC__\
          #define __BEGIN_DECLS extern "C" {\
          #define __END_DECLS }\
          #endif\
          #else\
          #ifndef __GLIBC__\
          #define __BEGIN_DECLS\
          #define __END_DECLS\
          #endif\
          #endif' {} +

          sed -i 's/__BEGIN_DECLS/#ifdef __cplusplus\nextern "C" {\n#endif/g; s/__END_DECLS/#ifdef __cplusplus\n}\n#endif/g' ${PWD}/src/core/libpackagelistparser/include/packagelistparser/packagelistparser.h

          sed -i '/#include <sys\/limits.h>/d; /#include <log\/log.h>/a\
          #ifndef GID_MAX\n#define GID_MAX 2147483647\n#endif\n\
          #ifndef UID_MAX\n#define UID_MAX 2147483647\n#endif' ${PWD}/src/core/libpackagelistparser/packagelistparser.cpp

          sed -i 's/std::vector<const StringPiece>/std::vector<StringPiece>/g' ${PWD}/src/base/tools/aapt2/util/Files.cpp

          sed -i '/#elif defined(OPENSSL_RISCV64)/a \#elif defined(OPENSSL_LOONG64)\n\#define EXPECTED_NR_getrandom 278' ${PWD}/src/boringssl/src/crypto/fipsmodule/rand/getrandom_fillin.h
          sed -i '/#elif defined(__MIPSEL__) && !defined(__LP64__)/i \#elif defined(__loongarch64)\n\#define OPENSSL_64_BIT\n\#define OPENSSL_LOONG64' ${PWD}/src/boringssl/src/include/openssl/target.h
          sed '/#include "trace-dev.inc"/a\
          #define PROP_NAME_MAX 32
          ' ${PWD}/src/core/libcutils/trace-dev.cpp

          mkdir -p "${PWD}/src/core/libcutils/include/linux" && cat <<'EOF' > "${PWD}/src/core/libcutils/include/linux/ashmem.h"
          /* SPDX-License-Identifier: GPL-2.0 OR Apache-2.0 */
          /*
          * Drop-in replacement for <linux/ashmem.h>
          * Combines uapi and kernel-space ashmem interface for userspace builds
          * Origin: Android Open Source Project
          */

          #ifndef _LINUX_ASHMEM_H
          #define _LINUX_ASHMEM_H

          #include <linux/ioctl.h>
          #include <linux/types.h>

          #define ASHMEM_NAME_LEN      256
          #define ASHMEM_NAME_DEF      "dev/ashmem"

          /* Return values from ASHMEM_PIN: Was the mapping purged while unpinned? */
          #define ASHMEM_NOT_PURGED    0
          #define ASHMEM_WAS_PURGED    1

          /* Return values from ASHMEM_GET_PIN_STATUS: Is the mapping pinned? */
          #define ASHMEM_IS_UNPINNED   0
          #define ASHMEM_IS_PINNED     1

          struct ashmem_pin {
              __u32 offset; /* offset into region, in bytes, page-aligned */
              __u32 len;    /* length forward from offset, in bytes, page-aligned */
          };

          #define __ASHMEMIOC                0x77

          #define ASHMEM_SET_NAME            _IOW(__ASHMEMIOC, 1, char[ASHMEM_NAME_LEN])
          #define ASHMEM_GET_NAME            _IOR(__ASHMEMIOC, 2, char[ASHMEM_NAME_LEN])
          #define ASHMEM_SET_SIZE            _IOW(__ASHMEMIOC, 3, size_t)
          #define ASHMEM_GET_SIZE            _IO(__ASHMEMIOC, 4)
          #define ASHMEM_SET_PROT_MASK       _IOW(__ASHMEMIOC, 5, unsigned long)
          #define ASHMEM_GET_PROT_MASK       _IO(__ASHMEMIOC, 6)
          #define ASHMEM_PIN                 _IOW(__ASHMEMIOC, 7, struct ashmem_pin)
          #define ASHMEM_UNPIN               _IOW(__ASHMEMIOC, 8, struct ashmem_pin)
          #define ASHMEM_GET_PIN_STATUS      _IO(__ASHMEMIOC, 9)
          #define ASHMEM_PURGE_ALL_CACHES    _IO(__ASHMEMIOC, 10)

          /* Optional: for 32-bit userspace on 64-bit kernel */
          #ifdef CONFIG_COMPAT
          #include <linux/compat.h>
          #define COMPAT_ASHMEM_SET_SIZE     _IOW(__ASHMEMIOC, 3, compat_size_t)
          #define COMPAT_ASHMEM_SET_PROT_MASK _IOW(__ASHMEMIOC, 5, unsigned int)
          #endif

          #endif /* _LINUX_ASHMEM_H */
          EOF

      - name: Build ZLIB
        run: |
          TOOLCHAIN=${{ github.workspace }}/zig-as-llvm
          export CC=${TOOLCHAIN}/bin/cc
          export CXX=${TOOLCHAIN}/bin/c++
          export CFLAGS="-fsanitize=undefined"
          export CXXFLAGS="-fsanitize=undefined"
          export LD=${TOOLCHAIN}/bin/ld
          export OBJCOPY=${TOOLCHAIN}/bin/objcopy
          export AR=${TOOLCHAIN}/bin/ar
          export STRIP=${TOOLCHAIN}/bin/strip
          curl -LkSs https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.xz | xz -d | tar -x
          cd zlib-1.3.1
          ./configure --prefix="$(pwd)/../extrabuild" --static
          make -j"$(nproc --all)" install

      - name: Build Packages
        run: |
          chmod +x build.sh
          ./build.sh "${{ github.workspace }}/zig-as-llvm" "$(command -v protoc)" --build "build" --jobs "$(nproc)"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target_arch }}
          path: build
